# [用户交互指南](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id2)

内容

- [用户交互指南](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#user-interaction-guide)
  - [介绍](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#introduction)
    - [命令行 cmake 工具](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#command-line-cmake-tool)
    - [cmake-gui 工具](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#cmake-gui-tool)
  - [生成构建系统](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#generating-a-buildsystem)
    - [命令行环境](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#command-line-environment)
    - [命令行`-G`选项](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#command-line-g-option)
    - [在 cmake-gui 中选择生成器](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#choosing-a-generator-in-cmake-gui)
  - [设置构建变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#setting-build-variables)
    - [在命令行上设置变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#setting-variables-on-the-command-line)
    - [使用 cmake-gui 设置变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#setting-variables-with-cmake-gui)
    - [CMake 缓存](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#the-cmake-cache)
  - [预设](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#presets)
    - [在命令行上使用预设](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#using-presets-on-the-command-line)
    - [在 cmake-gui 中使用预设](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#using-presets-in-cmake-gui)
  - [调用构建系统](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#invoking-the-buildsystem)
    - [选择目标](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#selecting-a-target)
    - [指定构建程序](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#specifying-a-build-program)
  - [软件安装](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#software-installation)
  - [运行测试](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#running-tests)

## [Introduction](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id3)

如果软件包为基于 CMake 的构建系统提供其软件源，则软件的使用者需要运行 CMake 用户交互工具才能构建它。

表现良好的基于 CMake 的构建系统不会在源目录中创建任何输出，因此通常用户执行源外构建并在那里执行构建。首先，必须指示 CMake 生成合适的构建系统，然后用户调用构建工具来处理生成的构建系统。生成的构建系统特定于用于生成它的机器，并且不可再分发。提供的源软件包的每个使用者都需要使用 CMake 生成特定于其系统的构建系统。

生成的构建系统通常应被视为只读的。作为主要工件的 CMake 文件应该完全指定构建系统，并且没有理由在 IDE 中手动填充属性，例如在生成构建系统之后。CMake 会定期重写生成的构建系统，因此用户的修改将被覆盖。

通过提供 CMake 文件，本手册中描述的功能和用户界面可用于所有基于 CMake 的构建系统。

CMake 工具在处理提供的 CMake 文件时可能会向用户报告错误，例如报告不支持编译器，或者编译器不支持所需的编译选项，或者找不到依赖项。用户必须通过选择不同的编译器来解决这些错误， [`installing dependencies`](https://cmake.org/cmake/help/latest/guide/using-dependencies/index.html#guide:Using Dependencies Guide)，或指示 CMake 在哪里可以找到它们等。

### [命令行 cmake 工具](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id4)

一个简单但典型的用法[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))使用新的软件源代码副本创建一个构建目录并在那里调用 cmake：

```
$ cd some_software-1.4.2
$ mkdir build
$ cd build
$ cmake .. -DCMAKE_INSTALL_PREFIX=/opt/the/prefix
$ cmake --build .
$ cmake --build . --target install
```

建议在源代码的单独目录中构建，因为这样可以保持源目录的原始状态，允许使用多个工具链构建单个源代码，并且只需删除构建目录即可轻松清除构建工件。

CMake 工具可能会报告针对软件提供者的警告，而不是针对软件消费者的警告。此类警告以“此警告适用于项目开发人员”结尾。用户可以通过将`-Wno-dev`标志传递给 [`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1)).

### [cmake-gui tool](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id5)

更习惯于 GUI 界面的用户可能会使用 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))调用 CMake 并生成构建系统的工具。

必须首先填充源目录和二进制目录。始终建议对源代码和构建使用不同的目录。

![选择源目录和二进制目录](MarkDownImages/%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92%E6%8C%87%E5%8D%97.assets/GUI-Source-Binary.png)

## [生成构建系统](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id6)

有几种用户界面工具可用于从 CMake 文件生成构建系统。这 [`ccmake(1)`](https://cmake.org/cmake/help/latest/manual/ccmake.1.html#manual:ccmake(1))和[`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))工具引导用户设置各种必要的选项。这[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))可以调用工具来指定命令行上的选项。本手册描述了可以使用任何用户界面工具设置的选项，但设置选项的模式因每个工具而异。

### [命令行环境](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id7)

调用时[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))对于命令行构建系统，例如`Makefiles`or `Ninja`，必须使用正确的构建环境以确保构建工具可用。CMake 必须能够找到合适的 [`build tool`](https://cmake.org/cmake/help/latest/variable/CMAKE_MAKE_PROGRAM.html#variable:CMAKE_MAKE_PROGRAM)、编译器、链接器和其他需要的工具。

在 Linux 系统上，适当的工具通常在系统范围的位置提供，并且可以通过系统包管理器轻松安装。也可以使用用户提供的或安装在非默认位置的其他工具链。

交叉编译时，某些平台可能需要设置环境变量，或者可能提供脚本来设置环境。

Visual Studio 提供了多个命令提示符和 `vcvarsall.bat`脚本，用于为命令行构建系统设置正确的环境。虽然在使用 Visual Studio 生成器时使用相应的命令行环境并不是绝对必要的，但这样做没有任何缺点。

使用 Xcode 时，可以安装多个 Xcode 版本。可以通过多种不同方式选择使用哪一种，但最常用的方法是：

- 在 Xcode IDE 的首选项中设置默认版本。
- `xcode-select` 通过命令行工具设置默认版本。
- `DEVELOPER_DIR`通过在运行 CMake 和构建工具时设置环境变量来覆盖默认版本 。

为了方便，[`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))提供环境变量编辑器。

### [命令行`-G`选项](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id8)

CMake 默认根据平台选择生成器。通常，默认生成器足以让用户继续构建软件。

用户可以使用以下选项覆盖默认生成器`-G`：

```
$ cmake .. -G Ninja
```

的输出包括一个列表 `cmake --help`[`generators`](https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html#manual:cmake-generators(7))可供用户选择。请注意，生成器名称区分大小写。

在类 Unix 系统（包括 Mac OS X）上， [`Unix Makefiles`](https://cmake.org/cmake/help/latest/generator/Unix Makefiles.html#generator:Unix Makefiles)默认使用生成器。该生成器的变体也可以在 Windows 上的各种环境中使用，例如 [`NMake Makefiles`](https://cmake.org/cmake/help/latest/generator/NMake Makefiles.html#generator:NMake Makefiles)和 [`MinGW Makefiles`](https://cmake.org/cmake/help/latest/generator/MinGW Makefiles.html#generator:MinGW Makefiles)发电机。这些生成器生成`Makefile`可以使用 、 或类似工具执行`make`的`gmake`变`nmake`体。有关目标环境和工具的更多信息，请参阅单独的生成器文档。

这[`Ninja`](https://cmake.org/cmake/help/latest/generator/Ninja.html#generator:Ninja)生成器可在所有主要平台上使用。`ninja`是一种在用例中类似于 的构建工具`make`，但侧重于性能和效率。

在 Windows 上，[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))可用于为 Visual Studio IDE 生成解决方案。Visual Studio 版本可以由 IDE 的产品名称指定，其中包括四位数的年份。为有时引用 Visual Studio 版本的其他方式提供别名，例如对应于 VisualC++ 编译器的产品版本的两位数字，或两者的组合：

```
$ cmake .. -G "Visual Studio 2019"
$ cmake .. -G "Visual Studio 16"
$ cmake .. -G "Visual Studio 16 2019"
```

Visual Studio 生成器可以针对不同的体系结构。可以使用-A选项指定目标架构：

```
cmake .. -G "Visual Studio 2019" -A x64
cmake .. -G "Visual Studio 16" -A ARM
cmake .. -G "Visual Studio 16 2019" -A ARM64
```

在苹果上，[`Xcode`](https://cmake.org/cmake/help/latest/generator/Xcode.html#generator:Xcode)生成器可用于为 Xcode IDE 生成项目文件。

一些 IDE，例如 KDevelop4、QtCreator 和 CLion，对基于 CMake 的构建系统具有原生支持。这些 IDE 提供了用于选择要使用的底层生成器的用户界面，通常是在生成器`Makefile` 或`Ninja`基于生成器之间进行选择。

`-G`请注意，在第一次调用 CMake 后无法更改生成器。要更改生成器，必须删除构建目录并且必须从头开始构建。

在生成 Visual Studio 项目和解决方案文件时，初始运行时可以使用其他几个选项[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1)).

可以使用以下 `-T`选项指定 Visual Studio 工具集：

```
$ # Build with the clang-cl toolset
$ cmake.exe .. -G "Visual Studio 16 2019" -A x64 -T ClangCL
$ # Build targeting Windows XP
$ cmake.exe .. -G "Visual Studio 16 2019" -A x64 -T v120_xp
```

尽管该`-A`选项指定了_target_架构，但该`-T`选项可用于指定所用工具链的详细信息。例如，可以给出-Thost=x64 来选择 64 位版本的主机工具。下面演示了如何使用 64 位工具以及如何构建 64 位目标架构：

```
$ cmake .. -G "Visual Studio 16 2019" -A x64 -Thost=x64
```

### [在 cmake-gui 中选择生成器](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id9)

“配置”按钮会触发一个新对话框来选择要使用的 CMake 生成器。

![配置生成器](MarkDownImages/%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92%E6%8C%87%E5%8D%97.assets/GUI-Configure-Dialog.png)

命令行上可用的所有生成器也可在[`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1)).

![选择发电机](MarkDownImages/%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92%E6%8C%87%E5%8D%97.assets/GUI-Choose-Generator.png)

选择 Visual Studio 生成器时，可以使用更多选项来设置要为其生成的体系结构。

![为 Visual Studio 生成器选择体系结构](MarkDownImages/%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92%E6%8C%87%E5%8D%97.assets/VS-Choose-Arch.png)



## [设置构建变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id10)

软件项目在调用 CMake 时通常需要在命令行上设置变量。下表列出了一些最常用的 CMake 变量：

| 多变的                                                       | 意义                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`CMAKE_PREFIX_PATH`](https://cmake.org/cmake/help/latest/variable/CMAKE_PREFIX_PATH.html#variable:CMAKE_PREFIX_PATH) | 搜索路径 [`dependent packages`](https://cmake.org/cmake/help/latest/guide/using-dependencies/index.html#guide:Using Dependencies Guide) |
| [`CMAKE_MODULE_PATH`](https://cmake.org/cmake/help/latest/variable/CMAKE_MODULE_PATH.html#variable:CMAKE_MODULE_PATH) | 搜索其他 CMake 模块的路径                                    |
| [`CMAKE_BUILD_TYPE`](https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html#variable:CMAKE_BUILD_TYPE) | 构建配置，例如 `Debug`或`Release`，确定调试/优化标志。这仅适用于单一配置的构建系统，例如`Makefile`和`Ninja`。多配置构建系统（例如 Visual Studio 和 Xcode 的构建系统）会忽略此设置。 |
| [`CMAKE_INSTALL_PREFIX`](https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html#variable:CMAKE_INSTALL_PREFIX) | 将软件安装到 `install`构建目标的位置                         |
| [`CMAKE_TOOLCHAIN_FILE`](https://cmake.org/cmake/help/latest/variable/CMAKE_TOOLCHAIN_FILE.html#variable:CMAKE_TOOLCHAIN_FILE) | 包含交叉编译数据的文件，例如 [`toolchains and sysroots`](https://cmake.org/cmake/help/latest/manual/cmake-toolchains.7.html#manual:cmake-toolchains(7)). |
| [`BUILD_SHARED_LIBS`](https://cmake.org/cmake/help/latest/variable/BUILD_SHARED_LIBS.html#variable:BUILD_SHARED_LIBS) | 是否构建共享库而不是静态库[`add_library()`](https://cmake.org/cmake/help/latest/command/add_library.html#command:add_library) 不带类型使用的命令 |
| [`CMAKE_EXPORT_COMPILE_COMMANDS`](https://cmake.org/cmake/help/latest/variable/CMAKE_EXPORT_COMPILE_COMMANDS.html#variable:CMAKE_EXPORT_COMPILE_COMMANDS) | 生成`compile_commands.json` 文件以与基于 clang 的工具一起使用 |

其他特定于项目的变量可能可用于控制构建，例如启用或禁用项目的组件。

CMake没有提供关于如何在不同提供的构建系统之间命名这些变量的约定，除了带有前缀的变量`CMAKE_`通常引用CMake本身提供的选项并且不应该在第三方选项中使用，应该使用他们自己的前缀代替. 这 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))工具可以按其前缀定义的组显示选项，因此第三方确保他们使用自洽的前缀是有意义的。

### [在命令行上设置变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id11)

可以在创建初始构建时在命令行上设置 CMake 变量：

```
$ mkdir build
$ cd build
$ cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Debug
```

或稍后在随后调用 [`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1)):

```
$ cd build
$ cmake . -DCMAKE_BUILD_TYPE=Debug
```

该`-U`标志可用于取消设置变量[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))命令行：

```
$ cd build
$ cmake . -UMyPackage_DIR
```

最初在命令行上创建的 CMake 构建系统可以使用 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))反之亦然。

这[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))`-C`工具允许使用该选项指定用于填充初始缓存的文件。这对于简化重复需要相同缓存条目的命令和脚本很有用。

### [使用 cmake-gui 设置变量](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id12)

可以使用“添加条目”按钮在 cmake-gui 中设置变量。这会触发一个新对话框来设置变量的值。

![编辑缓存条目](MarkDownImages/%E7%94%A8%E6%88%B7%E4%BA%A4%E4%BA%92%E6%8C%87%E5%8D%97.assets/GUI-Add-Entry.png)

主视图[`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))用户界面可用于编辑现有变量。

### [CMake 缓存](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id13)

CMake 执行时，需要查找编译器、工具和依赖项的位置。它还需要能够始终如一地重新生成构建系统以使用相同的编译/链接标志和依赖关系路径。这些参数也需要用户可配置，因为它们是特定于用户系统的路径和选项。

首次执行时，CMake `CMakeCache.txt`会在构建目录中生成一个文件，其中包含此类工件的键值对。用户可以通过运行 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))或者[`ccmake(1)`](https://cmake.org/cmake/help/latest/manual/ccmake.1.html#manual:ccmake(1))工具。这些工具提供了一个交互式界面，用于重新配置所提供的软件和重新生成构建系统，这是在编辑缓存值之后需要的。每个缓存条目可能有一个相关的简短帮助文本，显示在用户界面工具中。

缓存条目也可能有一个类型来表示它应该如何在用户界面中呈现。例如，类型的缓存条目`BOOL`可以通过用户界面中的复选框进行`STRING`编辑，a 可以在文本字段中进行编辑，并且`FILEPATH`类似于 a `STRING`还应该提供一种使用文件对话框定位文件系统路径的方法。一个类型的条目`STRING` 可以提供一个受限制的允许值列表，然后在下拉菜单中提供 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))用户界面（见 [`STRINGS`](https://cmake.org/cmake/help/latest/prop_cache/STRINGS.html#prop_cache:STRINGS)缓存属性）。

软件包附带的 CMake 文件也可以使用[`option()`](https://cmake.org/cmake/help/latest/command/option.html#command:option) 命令。该命令创建一个包含帮助文本和默认值的缓存条目。此类缓存条目通常特定于所提供的软件并影响构建的配置，例如是否构建测试和示例，是否构建启用异常等。

## [Presets](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id14)

CMake 理解文件`CMakePresets.json`及其用户特定对应文件`CMakeUserPresets.json`，用于保存常用配置设置的预设。这些预设可以设置构建目录、生成器、缓存变量、环境变量和其他命令行选项。所有这些选项都可以被用户覆盖。格式的完整详细信息`CMakePresets.json`列在[`cmake-presets(7)`](https://cmake.org/cmake/help/latest/manual/cmake-presets.7.html#manual:cmake-presets(7))手动的。

### [在命令行上使用预设](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id15)

使用时[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))命令行工具，可以使用`--preset`选项调用预设。如果 `--preset`指定，则不需要生成器和构建目录，但可以指定以覆盖它们。例如，如果您有以下 `CMakePresets.json`文件：

```
{
  "version": 1,
  "configurePresets": [
    {
      "name": "ninja-release",
      "binaryDir": "${sourceDir}/build/${presetName}",
      "generator": "Ninja",
      "cacheVariables": {
        "CMAKE_BUILD_TYPE": "Release"
      }
    }
  ]
}
```

你运行以下命令：

```
cmake -S /path/to/source --preset=ninja-release
```

`/path/to/source/build/ninja-release`这将在其中 生成一个构建目录 [`Ninja`](https://cmake.org/cmake/help/latest/generator/Ninja.html#generator:Ninja)发电机，并与 [`CMAKE_BUILD_TYPE`](https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html#variable:CMAKE_BUILD_TYPE)设置为`Release`.

如果要查看可用预设列表，可以运行：

```
cmake -S /path/to/source --list-presets
```

这将列出可用的预设 `/path/to/source/CMakePresets.json`和 `/path/to/source/CMakeUsersPresets.json`不生成构建树。

### [在 cmake-gui 中使用预设](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id16)

如果项目有可用的预设，通过 `CMakePresets.json`或`CMakeUserPresets.json`，预设列表将出现在下拉菜单中 [`cmake-gui(1)`](https://cmake.org/cmake/help/latest/manual/cmake-gui.1.html#manual:cmake-gui(1))在源目录和二进制目录之间。选择预设会设置二进制目录、生成器、环境变量和缓存变量，但是在选择预设后，所有这些选项都可以被覆盖。

## [调用构建系统](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id17)

在生成构建系统之后，可以通过调用特定的构建工具来构建软件。对于 IDE 生成器，这可能涉及将生成的项目文件加载到 IDE 中以调用构建。

CMake 知道调用构建所需的特定构建工具，因此一般来说，要在生成后从命令行构建构建系统或项目，可以在构建目录中调用以下命令：

```
$ cmake --build .
```

该`--build`标志启用特定的操作模式[`cmake(1)`](https://cmake.org/cmake/help/latest/manual/cmake.1.html#manual:cmake(1))工具。它调用 [`CMAKE_MAKE_PROGRAM`](https://cmake.org/cmake/help/latest/variable/CMAKE_MAKE_PROGRAM.html#variable:CMAKE_MAKE_PROGRAM)与相关的命令[`generator`](https://cmake.org/cmake/help/latest/manual/cmake-generators.7.html#manual:cmake-generators(7))，或者用户配置的构建工具。

该`--build`模式还接受参数 `--target`来指定要构建的特定目标，例如特定库、可执行或自定义目标，或特定特殊目标，例如 `install`：

```
$ cmake --build . --target myexe
```

在多配置生成器的情况下，该`--build`模式还接受一个参数来指定要构建的特定配置：`--config`

```
$ cmake --build . --target myexe --config Release
```

`--config`如果生成器生成特定于在调用 cmake 时选择的配置的构建系统，则 该选项无效[`CMAKE_BUILD_TYPE`](https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html#variable:CMAKE_BUILD_TYPE)多变的。

一些构建系统省略了构建期间调用的命令行的详细信息。该`--verbose`标志可用于显示这些命令行：

```
$ cmake --build . --target myexe --verbose
```

该`--build`模式还可以通过在`--`. 这对于指定构建工具的选项很有用，例如在作业失败后继续构建，其中 CMake 不提供高级用户界面。

对于所有生成器，都可以在调用 CMake 后运行底层构建工具。例如，`make` 可以在生成后执行 [`Unix Makefiles`](https://cmake.org/cmake/help/latest/generator/Unix Makefiles.html#generator:Unix Makefiles)生成器来调用构建，或者`ninja`在生成之后[`Ninja`](https://cmake.org/cmake/help/latest/generator/Ninja.html#generator:Ninja) 生成器等。IDE 构建系统通常提供命令行工具来构建也可以调用的项目。

### [选择目标](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id18)

CMake 文件中描述的每个可执行文件和库都是一个构建目标，构建系统可以描述自定义目标，供内部使用或供用户使用，例如创建文档。

CMake 为所有提供 CMake 文件的构建系统提供了一些内置目标。

- `all`

  `Makefile`和生成器使用的默认目标`Ninja` 。构建构建系统中的所有目标，除了那些被其排除的目标 [`EXCLUDE_FROM_ALL`](https://cmake.org/cmake/help/latest/prop_tgt/EXCLUDE_FROM_ALL.html#prop_tgt:EXCLUDE_FROM_ALL)目标财产或 [`EXCLUDE_FROM_ALL`](https://cmake.org/cmake/help/latest/prop_dir/EXCLUDE_FROM_ALL.html#prop_dir:EXCLUDE_FROM_ALL)目录属性。此名称`ALL_BUILD`用于 Xcode 和 Visual Studio 生成器。

- `help`

  列出可用于构建的目标。该目标在使用[`Unix Makefiles`](https://cmake.org/cmake/help/latest/generator/Unix Makefiles.html#generator:Unix Makefiles)或者 [`Ninja`](https://cmake.org/cmake/help/latest/generator/Ninja.html#generator:Ninja)生成器，并且确切的输出是特定于工具的。

- `clean`

  删除构建的目标文件和其他输出文件。基于 `Makefile`的生成器为每个目录创建一个`clean`目标，以便可以清理单个目录。该`Ninja`工具提供了自己的粒度 系统。`-t clean`

- `test`

  运行测试。仅当 CMake 文件提供基于 CTest 的测试时，此目标才会自动可用。另请参阅 [运行测试](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#running-tests)。

- `install`

  安装软件。此目标仅在软件定义安装规则时自动可用 [`install()`](https://cmake.org/cmake/help/latest/command/install.html#command:install)命令。另请参阅 [软件安装](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#software-installation)。

- `package`

  创建一个二进制包。仅当 CMake 文件提供基于 CPack 的包时，此目标才自动可用。

- `package_source`

  创建一个源包。仅当 CMake 文件提供基于 CPack 的包时，此目标才自动可用。

对于`Makefile`基于系统，`/fast`提供了二进制构建目标的变体。`/fast`变体用于构建指定的目标，而不考虑其依赖关系。不检查依赖关系，如果过时也不会重建。这[`Ninja`](https://cmake.org/cmake/help/latest/generator/Ninja.html#generator:Ninja) 生成器在依赖性检查方面足够快，没有为该生成器提供此类目标。

`Makefile`基于系统的系统还提供构建目标来预处理、组装和编译特定目录中的单个文件。

```
$ make foo.cpp.i
$ make foo.cpp.s
$ make foo.cpp.o
```

文件扩展名内置在目标名称中，因为可能存在另一个具有相同名称但扩展名不同的文件。但是，还提供了没有文件扩展名的构建目标。

```
$ make foo.i
$ make foo.s
$ make foo.o
```

在包含`foo.c`和的构建系统中`foo.cpp`，构建`foo.i`目标将预处理这两个文件。

### [指定构建程序](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id19)

该`--build`模式调用的程序由[`CMAKE_MAKE_PROGRAM`](https://cmake.org/cmake/help/latest/variable/CMAKE_MAKE_PROGRAM.html#variable:CMAKE_MAKE_PROGRAM)多变的。对于大多数生成器，不需要配置特定程序。

| 发电机              | 默认制作程序   | 备择方案 |
| :------------------ | :------------- | :------- |
| 代码                | `xcodebuild`   |          |
| Unix Makefiles      | `make`         |          |
| NMake 生成文件      | `nmake`        | `jom`    |
| NMake Makefiles JOM | `jom`          | `nmake`  |
| MinGW Makefiles     | `mingw32-make` |          |
| MSYS 生成文件       | `make`         |          |
| 忍者                | `ninja`        |          |
| 视觉工作室          | `msbuild`      |          |
| Watcom WMake        | `wmake`        |          |

该`jom`工具能够读取 `NMake`风格的 makefile 并并行构建，而该 `nmake`工具总是串行构建。生成后[`NMake Makefiles`](https://cmake.org/cmake/help/latest/generator/NMake Makefiles.html#generator:NMake Makefiles)生成器用户可以运行`jom`而不是`nmake`. 如果 _ `--build` _`jom`[`CMAKE_MAKE_PROGRAM`](https://cmake.org/cmake/help/latest/variable/CMAKE_MAKE_PROGRAM.html#variable:CMAKE_MAKE_PROGRAM)`jom`使用时设置为[`NMake Makefiles`](https://cmake.org/cmake/help/latest/generator/NMake Makefiles.html#generator:NMake Makefiles)生成器，并且为方便起见，[`NMake Makefiles JOM`](https://cmake.org/cmake/help/latest/generator/NMake Makefiles JOM.html#generator:NMake Makefiles JOM) 提供生成器以`jom`正常方式查找并将其用作[`CMAKE_MAKE_PROGRAM`](https://cmake.org/cmake/help/latest/variable/CMAKE_MAKE_PROGRAM.html#variable:CMAKE_MAKE_PROGRAM). 为了完整起见，`nmake`是一种替代工具，可以处理 [`NMake Makefiles JOM`](https://cmake.org/cmake/help/latest/generator/NMake Makefiles JOM.html#generator:NMake Makefiles JOM)发电机，但这样做将是悲观的。

## [软件安装](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id20)

这[`CMAKE_INSTALL_PREFIX`](https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html#variable:CMAKE_INSTALL_PREFIX)可以在 CMake 缓存中设置变量以指定安装所提供软件的位置。如果提供的软件具有安装规则，则使用[`install()`](https://cmake.org/cmake/help/latest/command/install.html#command:install)命令，他们会将工件安装到该前缀中。在 Windows 上，默认安装位置对应于 `ProgramFiles`系统目录，该目录可能是特定于体系结构的。在 Unix 主机上，`/usr/local`是默认安装位置。

这[`CMAKE_INSTALL_PREFIX`](https://cmake.org/cmake/help/latest/variable/CMAKE_INSTALL_PREFIX.html#variable:CMAKE_INSTALL_PREFIX)变量总是指目标文件系统上的安装前缀。

在 sysroot 为只读或 sysroot 应保持原始状态的交叉编译或打包方案中，[`CMAKE_STAGING_PREFIX`](https://cmake.org/cmake/help/latest/variable/CMAKE_STAGING_PREFIX.html#variable:CMAKE_STAGING_PREFIX) 变量可以设置为实际安装文件的位置。

命令：

```
$ cmake .. -DCMAKE_INSTALL_PREFIX=/usr/local \
  -DCMAKE_SYSROOT=$HOME/root \
  -DCMAKE_STAGING_PREFIX=/tmp/package
$ cmake --build .
$ cmake --build . --target install
```

导致文件被安装到`/tmp/package/lib/libfoo.so`主机上等路径。主机上的`/usr/local`位置不受影响。

某些提供的软件可能会指定`uninstall`规则，但默认情况下 CMake 本身不会生成此类规则。

## [运行测试](https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#id21)

这[`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1))该工具随 CMake 发行版一起提供，用于执行提供的测试并报告结果。提供`test`build-target 来运行所有可用的测试，但是[`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1))工具允许对运行哪些测试、如何运行以及如何报告结果进行精细控制。执行 [`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1))在构建目录中相当于运行`test`目标：

```
$ ctest
```

可以传递正则表达式以仅运行与表达式匹配的测试。`Qt`仅以他们的名义运行测试 ：

```
$ ctest -R Qt
```

也可以通过正则表达式排除测试。只运行没有`Qt`名字的测试：

```
$ ctest -E Qt
```

测试可以通过将`-j`参数传递给并行运行[`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1)):

```
$ ctest -R Qt -j8
```

环境变量[`CTEST_PARALLEL_LEVEL`](https://cmake.org/cmake/help/latest/envvar/CTEST_PARALLEL_LEVEL.html#envvar:CTEST_PARALLEL_LEVEL) 也可以通过设置来避免需要通过 `-j`。

默认[`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1))不打印测试的输出。命令行参数`-V`（或 `--verbose`）启用详细模式以打印所有测试的输出。该`--output-on-failure`选项仅打印失败测试的测试输出。环境变量 [`CTEST_OUTPUT_ON_FAILURE`](https://cmake.org/cmake/help/latest/envvar/CTEST_OUTPUT_ON_FAILURE.html#envvar:CTEST_OUTPUT_ON_FAILURE) 可以设置为`1`作为将 `--output-on-failure`选项传递给的替代方法[`ctest(1)`](https://cmake.org/cmake/help/latest/manual/ctest.1.html#manual:ctest(1)).